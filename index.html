<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مصحف "تبيان" - نسخة تعمل</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Amiri+Quran&family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #f9f6f1;
            --text-color: #2c3e50;
            --primary-color: #27ae60;
            --golden-color: #d4af37;
            --panel-bg: #ffffff;
            --loader-color: var(--primary-color);
        }
        body {
            font-family: 'Cairo', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            transition: padding-left 0.4s ease;
        }
        .main-header { text-align: center; margin-bottom: 20px; }
        .main-header h1 { font-family: 'Amiri Quran', serif; color: var(--primary-color); margin: 0; }
        .sura-selector {
            display: block; width: 100%; max-width: 400px; margin: 20px auto;
            padding: 10px; font-family: 'Cairo', sans-serif; font-size: 1rem;
            border: 1px solid #ddd; border-radius: 8px;
        }
        .sura-container {
            max-width: 800px; margin: 0 auto;
            background: rgba(255, 255, 255, 0.5); border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            min-height: 200px; position: relative;
        }
        
        .sura-info-box {
            padding: 20px;
            background-color: rgba(39, 174, 96, 0.05);
            border-bottom: 1px solid rgba(39, 174, 96, 0.1);
            text-align: center;
        }
        .sura-info-box h2 {
            font-family: 'Amiri Quran', serif;
            font-size: 2.5rem;
            margin: 0 0 10px 0;
            color: var(--primary-color);
        }
        .sura-info-box .meta-info {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            color: #555;
            margin-bottom: 15px;
        }
        .sura-info-box .meta-info span {
            background-color: rgba(0,0,0,0.05);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        .sura-info-box .bismillah {
            font-family: 'Amiri Quran', serif;
            font-size: 2rem;
            color: var(--text-color);
            padding-top: 15px;
            border-top: 1px dashed #ccc;
            margin-top: 15px;
        }
        
        .ayah-list { padding: 0 20px 20px 20px; }
        .ayah {
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px 0; border-bottom: 1px solid #eee;
            cursor: pointer; transition: background-color 0.2s ease;
        }
        .ayah:hover { background-color: rgba(39, 174, 96, 0.08); }
        .ayah.active { background-color: rgba(212, 175, 55, 0.15); }
        .ayah-text { font-family: 'Amiri Quran', serif; font-size: 1.8rem; flex-grow: 1; margin: 0; pointer-events: none; }
        .ayah-number {
            font-family: 'Cairo', sans-serif; font-size: 1rem; font-weight: bold;
            color: var(--primary-color); background-color: rgba(39, 174, 96, 0.1);
            border-radius: 50%; min-width: 35px; height: 35px;
            display: flex; align-items: center; justify-content: center;
            margin-right: 20px; pointer-events: none;
        }
        
        .info-panel {
            position: fixed; top: 0; left: 0; width: 380px; height: 100%;
            background-color: var(--panel-bg);
            box-shadow: -5px 0 25px rgba(0, 0, 0, 0.1);
            transform: translateX(-100%); transition: transform 0.4s ease;
            z-index: 1000; overflow-y: auto;
            padding: 20px; padding-top: 60px; box-sizing: border-box;
        }
        .info-panel.open { transform: translateX(0); }
        .close-btn { position: absolute; top: 15px; left: 15px; background: none; border: none; font-size: 2.5rem; color: #aaa; cursor: pointer; line-height: 1; }
        .panel-content { padding: 10px; position: relative; }
        .panel-ayah-text { font-family: 'Amiri Quran', serif; font-size: 2rem; color: var(--primary-color); text-align: center; margin-bottom: 25px; border-bottom: 2px solid var(--golden-color); padding-bottom: 20px; }
        .panel-section { margin-bottom: 20px; }
        .panel-section h3 { font-size: 1.2rem; margin-bottom: 5px; border-right: 3px solid var(--primary-color); padding-right: 10px; }
        .panel-section p { font-size: 1rem; color: #555; line-height: 1.7; margin: 0; }
        
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid var(--loader-color);
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @media (max-width: 768px) { .info-panel { width: 90%; } }
    </style>
</head>
<body>

    <header class="main-header">
        <h1>تبيان</h1>
        <p>مصحف إلكتروني حديث</p>
        <select id="sura-selector" class="sura-selector">
            <option value="">اختر سورة...</option>
        </select>
    </header>

    <main id="sura-container" class="sura-container">
        <p style="text-align:center; padding: 50px;">الرجاء اختيار سورة من القائمة أعلاه لبدء التلاوة.</p>
    </main>

    <aside id="info-panel" class="info-panel">
        <button id="close-panel-btn" class="close-btn">×</button>
        <div id="panel-content" class="panel-content"></div>
    </aside>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const suraSelector = document.getElementById('sura-selector');
            const suraContainer = document.getElementById('sura-container');
            const infoPanel = document.getElementById('info-panel');
            const closePanelBtn = document.getElementById('close-panel-btn');
            const panelContent = document.getElementById('panel-content');
            
            let lastActiveAyah = null;
            let allSurasInfo = []; 

            function showLoader(container) {
                container.innerHTML = '<div class="loader"></div>';
            }

            async function loadAllSuras() {
                try {
                    const response = await fetch('https://api.quran.com/api/v4/chapters?language=ar');
                    if (!response.ok) throw new Error('Failed to load sura list');
                    const data = await response.json();
                    allSurasInfo = data.chapters;
                    
                    allSurasInfo.forEach(sura => {
                        const option = document.createElement('option');
                        option.value = sura.id;
                        option.textContent = `${sura.id}. ${sura.name_arabic} (${sura.name_simple})`;
                        suraSelector.appendChild(option);
                    });
                } catch (error) {
                    suraContainer.innerHTML = '<p>عفواً، حدث خطأ أثناء تحميل قائمة السور.</p>';
                }
            }

            async function loadSura(suraNumber) {
                showLoader(suraContainer);
                try {
                    const [infoRes, versesRes] = await Promise.all([
                        fetch(`https://api.quran.com/api/v4/chapters/${suraNumber}/info?language=ar`),
                        fetch(`https://api.quran.com/api/v4/quran/verses/uthmani?chapter_number=${suraNumber}`)
                    ]);

                    if (!infoRes.ok || !versesRes.ok) throw new Error('Failed to load sura data');
                    
                    const infoData = await infoRes.json();
                    const versesData = await versesRes.json();
                    const suraInfo = allSurasInfo.find(s => s.id == suraNumber);
                    
                    const infoBoxHTML = `
                        <div class="sura-info-box">
                            <h2>${suraInfo.name_arabic}</h2>
                            <div class="meta-info">
                                <span>${suraInfo.revelation_place === 'makkah' ? 'مكية' : 'مدنية'}</span>
                                <span>${suraInfo.verses_count} آيات</span>
                                <span>السورة رقم ${suraInfo.id}</span>
                                <span>${suraInfo.name_simple}</span>
                            </div>
                            ${suraNumber != 1 && suraNumber != 9 ? '<p class="bismillah">بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ</p>' : ''}
                        </div>`;

                    let ayahsHTML = versesData.verses.map(ayah => {
                        let ayahText = ayah.text_uthmani;
                        if (suraNumber != 1 && ayah.verse_key.split(':')[1] == 1) {
                           ayahText = ayahText.replace('بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ', '').trim();
                        }
                        return `
                        <div class="ayah" data-verse-key="${ayah.verse_key}">
                            <p class="ayah-text">${ayahText}</p>
                            <span class="ayah-number">${ayah.verse_key.split(':')[1]}</span>
                        </div>`;
                    }).join('');

                    suraContainer.innerHTML = infoBoxHTML + `<div class="ayah-list">${ayahsHTML}</div>`;

                } catch (error) {
                    suraContainer.innerHTML = `<p>عفواً، حدث خطأ أثناء تحميل السورة. يرجى المحاولة مرة أخرى.</p>`;
                }
            }
            
            async function showInfoPanel(verseKey) {
                showLoader(panelContent);
                infoPanel.classList.add('open');

                try {
                    // --- التعديل الوحيد والمهم هنا ---
                    // تم تغيير رقم التفسير من 1 إلى 169 (الرقم الجديد للتفسير الميسر)
                    const tafsirID = 169; 
                    const translationID = 131; // Sahih International

                    const [tafsirRes, translationRes] = await Promise.all([
                        fetch(`https://api.quran.com/api/v4/quran/tafsirs/${tafsirID}?verse_key=${verseKey}`),
                        fetch(`https://api.quran.com/api/v4/quran/translations/${translationID}?verse_key=${verseKey}`)
                    ]);

                    if (!tafsirRes.ok || !translationRes.ok) {
                        throw new Error(`API request failed.`);
                    }

                    const tafsirData = await tafsirRes.json();
                    const translationData = await translationRes.json();
                    
                    const ayahElement = document.querySelector(`[data-verse-key="${verseKey}"]`);
                    const ayahText = ayahElement.querySelector('.ayah-text').textContent;
                    
                    const tafsirText = tafsirData.tafsirs?.[0]?.text;
                    const translationText = translationData.translations?.[0]?.text;

                    if (!tafsirText || !translationText) {
                        throw new Error("Data parsing error: Tafsir or translation text is missing.");
                    }
                    
                    panelContent.innerHTML = `
                        <div class="panel-ayah-text">${ayahText}</div>
                        <div class="panel-section">
                            <h3>التفسير الميسر</h3>
                            <p>${tafsirText}</p>
                        </div>
                        <div class="panel-section">
                            <h3>الترجمة (Sahih International)</h3>
                            <p>${translationText.replace(/<[^>]*>/g, '')}</p>
                        </div>
                        <div class="panel-section">
                            <h3>معلومات</h3>
                            <p>رقم الآية في المصحف: ${verseKey}</p>
                        </div>
                    `;

                } catch (error) {
                    console.error(`Error showing info for ${verseKey}:`, error);
                    panelContent.innerHTML = '<p style="text-align:center; padding: 20px;">عفواً، لم نتمكن من جلب معلومات هذه الآية. قد تكون هناك مشكلة في الاتصال بالإنترنت أو في خادم البيانات.</p>';
                }
            }

            function closeInfoPanel() {
                infoPanel.classList.remove('open');
                if (lastActiveAyah) {
                    lastActiveAyah.classList.remove('active');
                }
            }
            
            suraSelector.addEventListener('change', () => {
                if (suraSelector.value) {
                    closeInfoPanel();
                    loadSura(suraSelector.value);
                }
            });

            suraContainer.addEventListener('click', (event) => {
                const clickedAyah = event.target.closest('.ayah');
                if (clickedAyah) {
                    const verseKey = clickedAyah.dataset.verseKey;
                    showInfoPanel(verseKey);
                    
                    if (lastActiveAyah) lastActiveAyah.classList.remove('active');
                    clickedAyah.classList.add('active');
                    lastActiveAyah = clickedAyah;
                }
            });

            closePanelBtn.addEventListener('click', closeInfoPanel);

            loadAllSuras();
        });
    </script>
</body>
</html>